name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  BACKEND_IMAGE: ghcr.io/cercinaai/real-estate-backend
  DASHBOARD_IMAGE: ghcr.io/cercinaai/real-estate-dashboard
  CRAWLERS_IMAGE: ghcr.io/cercinaai/real-estate-crawlers

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ secrets.CI_REGISTRY_USER }}
        password: ${{ secrets.CI_REGISTRY_PASSWORD }}

    - name: Build and Push Backend Image
      run: |
        cd real-estate-backend
        docker build -t $BACKEND_IMAGE:$GITHUB_SHA -f ./docker/Dockerfile .
        docker tag $BACKEND_IMAGE:$GITHUB_SHA $BACKEND_IMAGE:latest
        docker push $BACKEND_IMAGE:$GITHUB_SHA
        docker push $BACKEND_IMAGE:latest

    - name: Build and Push Dashboard Image
      run: |
        cd real-estate-dashboard
        docker build -t $DASHBOARD_IMAGE:$GITHUB_SHA .
        docker tag $DASHBOARD_IMAGE:$GITHUB_SHA $DASHBOARD_IMAGE:latest
        docker push $DASHBOARD_IMAGE:$GITHUB_SHA
        docker push $DASHBOARD_IMAGE:latest

    - name: Deploy Backend
      run: |
        ssh -i ${{ secrets.SSH_PRIVATE_KEY }} -o StrictHostKeyChecking=no haythem@${{ secrets.BACKEND_HOST }} << 'EOF'
          docker login -u "${{ secrets.CI_REGISTRY_USER }}" -p "${{ secrets.CI_REGISTRY_PASSWORD }}" ghcr.io
          docker pull $BACKEND_IMAGE:latest
          docker pull $DASHBOARD_IMAGE:latest
          scp real-estate-backend/compose.prod.yml haythem@$BACKEND_HOST:/home/haythem/real-estate-backend/
          scp ${{ secrets.BACKEND_ENV_KEYS }} haythem@$BACKEND_HOST:/home/haythem/real-estate-backend/environments/production.env
          docker compose -f /home/haythem/real-estate-backend/compose.prod.yml down
          docker image prune -f
          docker compose -f /home/haythem/real-estate-backend/compose.prod.yml up -d
        EOF

    - name: Deploy Crawlers
      run: |
        ssh -i ${{ secrets.SSH_PRIVATE_KEY }} -o StrictHostKeyChecking=no haythem@${{ secrets.CRAWLERS_HOST }} << 'EOF'
          docker login -u "${{ secrets.CI_REGISTRY_USER }}" -p "${{ secrets.CI_REGISTRY_PASSWORD }}" ghcr.io
          docker pull $CRAWLERS_IMAGE:latest
          scp real-estate-crawlers/compose.prod.yml haythem@$CRAWLERS_HOST:/home/haythem/real-estate-crawlers/
          scp ${{ secrets.CRAWLERS_ENV_KEYS }} haythem@$CRAWLERS_HOST:/home/haythem/real-estate-crawlers/environments/production.env
          docker compose -f /home/haythem/real-estate-crawlers/compose.prod.yml down
          docker image prune -f
          docker compose -f /home/haythem/real-estate-crawlers/compose.prod.yml up -d
        EOF
